{{define "content"}}
<div class="space-y-6">
    <!-- Page Header -->
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-semibold text-gray-900 dark:text-white">
                Transactions
            </h1>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1 italic">Track your money flow</p>
        </div>
        <button onclick="openCreateModal()" class="btn-primary text-xs">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
            </svg>
            Add Transaction
        </button>
    </div>

    {{if .Error}}
    <div class="bg-red-500/10 border border-red-500/20 rounded-lg p-4">
        <p class="text-sm text-red-400">{{.Error}}</p>
    </div>
    {{end}}

    <!-- Filters -->
    <div class="card p-4">
        <form method="GET" action="/transactions" class="flex items-center gap-4">
            <div class="flex items-center gap-3">
                <div class="flex items-center gap-2 text-gray-500 dark:text-gray-400">
                    <i data-lucide="wallet" class="w-4 h-4"></i>
                    <span class="text-xs uppercase tracking-wider font-medium">Account</span>
                </div>
                <select name="account" onchange="this.form.submit()" class="select-sm w-auto">
                    <option value="">All Accounts</option>
                    {{range .Accounts}}
                    <option value="{{.ID}}" {{if eq .ID $.SelectedAccount}}selected{{end}}>{{.Name}}</option>
                    {{end}}
                </select>
            </div>
        </form>
    </div>

    <!-- Transactions List -->
    {{if .Transactions}}
    <div class="card overflow-visible">
        <table class="w-full overflow-visible">
            <thead>
                <tr class="border-b border-gray-200 dark:border-dark-border">
                    <th class="px-5 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Date</th>
                    <th class="px-5 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Description</th>
                    <th class="px-5 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Account</th>
                    <th class="px-5 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Amount</th>
                    <th class="px-5 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Balance</th>
                    <th class="px-5 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider"></th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-100 dark:divide-dark-border">
                {{range .Transactions}}
                <tr class="group hover:bg-gray-50 dark:hover:bg-dark-hover transition-colors">
                    <td class="px-5 py-4">
                        <span class="text-sm text-gray-600 dark:text-gray-300 font-mono">
                            {{.TransactionDate.Format "2006-01-02"}}
                        </span>
                    </td>
                    <td class="px-5 py-4">
                        <p class="text-sm text-gray-900 dark:text-white">
                            {{if .Description}}{{.Description}}{{else}}<span class="text-gray-400 italic">No description</span>{{end}}
                        </p>
                    </td>
                    <td class="px-5 py-4">
                        {{if .Account}}
                        <span class="text-sm text-gray-600 dark:text-gray-300">{{.Account.Name}}</span>
                        {{end}}
                    </td>
                    <td class="px-5 py-4 text-right">
                        <span class="text-sm font-medium tabular-nums {{if ge .Amount 0.0}}text-emerald-500{{else}}text-red-500{{end}}">
                            {{if ge .Amount 0.0}}+{{end}}{{formatNumberDecimals .Amount $.User.NumberFormat}}
                        </span>
                    </td>
                    <td class="px-5 py-4 text-right">
                        <span class="text-sm text-gray-600 dark:text-gray-300 tabular-nums">
                            {{formatNumberDecimals .BalanceAfter $.User.NumberFormat}}
                        </span>
                    </td>
                    <td class="px-5 py-4 text-right">
                        <div class="relative inline-block" x-data="{ open: false }">
                            <button @click="open = !open" class="p-1.5 rounded-lg text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 hover:bg-gray-100 dark:hover:bg-dark-hover opacity-0 group-hover:opacity-100 transition-opacity">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"></path>
                                </svg>
                            </button>
                            <div x-show="open" @click.away="open = false"
                                 x-transition:enter="transition ease-out duration-100"
                                 x-transition:enter-start="opacity-0 scale-95"
                                 x-transition:enter-end="opacity-100 scale-100"
                                 x-transition:leave="transition ease-in duration-75"
                                 x-transition:leave-start="opacity-100 scale-100"
                                 x-transition:leave-end="opacity-0 scale-95"
                                 class="absolute right-0 bottom-full mb-1 w-36 bg-white dark:bg-dark-surface border border-gray-200 dark:border-dark-border rounded-xl shadow-xl py-1.5 z-50"
                                 style="display: none;">
                                <button onclick="editTransaction({{.ID}}, {{.AccountID}}, {{.Amount}}, '{{.Description}}', '{{.TransactionDate.Format `2006-01-02`}}')" class="w-full px-3 py-2 flex items-center gap-2.5 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-dark-hover">
                                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                    </svg>
                                    Edit
                                </button>
                                <div class="border-t border-gray-100 dark:border-dark-border my-1"></div>
                                <form action="/transactions/{{.ID}}" method="POST" x-ref="deleteForm{{.ID}}"
                                      @submit.prevent="$store.confirm.show({
                                          title: 'Delete Transaction',
                                          message: 'Are you sure you want to delete this transaction? The account balance will be adjusted.',
                                          type: 'danger',
                                          confirmText: 'Delete',
                                          form: $refs.deleteForm{{.ID}}
                                      })">
                                    <input type="hidden" name="_method" value="DELETE">
                                    <button type="submit" class="w-full px-3 py-2 flex items-center gap-2.5 text-sm text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                        </svg>
                                        Delete
                                    </button>
                                </form>
                            </div>
                        </div>
                    </td>
                </tr>
                {{end}}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <div class="flex justify-between items-center">
        {{if gt .Page 1}}
        <a href="/transactions?page={{subtract .Page 1}}{{if .SelectedAccount}}&account={{.SelectedAccount}}{{end}}" class="btn-secondary text-xs">
            Previous
        </a>
        {{else}}
        <div></div>
        {{end}}

        <span class="text-sm text-gray-500 dark:text-gray-400">Page {{.Page}}</span>

        {{if .HasMore}}
        <a href="/transactions?page={{add .Page 1}}{{if .SelectedAccount}}&account={{.SelectedAccount}}{{end}}" class="btn-secondary text-xs">
            Next
        </a>
        {{else}}
        <div></div>
        {{end}}
    </div>
    {{else}}
    <!-- Empty State -->
    <div class="card p-12 text-center">
        <div class="w-16 h-16 mx-auto mb-4 rounded-2xl bg-gradient-to-br from-amber-500/20 to-orange-500/10 flex items-center justify-center">
            <svg class="w-8 h-8 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
            </svg>
        </div>
        <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-2">
            No transactions yet
        </h3>
        <p class="text-sm text-gray-500 dark:text-gray-400 mb-6 max-w-sm mx-auto">
            Start recording your transactions to track your wealth over time.
        </p>
        {{if .Accounts}}
        <button onclick="openCreateModal()" class="btn-primary text-sm">
            Add your first transaction
        </button>
        {{else}}
        <a href="/accounts" class="btn-primary text-sm">
            Create an account first
        </a>
        {{end}}
    </div>
    {{end}}
</div>

<!-- Create/Edit Modal -->
<div id="transactionModal" class="hidden fixed inset-0 z-50 overflow-y-auto">
    <div class="flex min-h-full items-center justify-center p-4">
        <!-- Backdrop -->
        <div class="fixed inset-0 bg-black/70 backdrop-blur-sm" onclick="closeModal()"></div>

        <!-- Modal -->
        <div class="relative bg-white dark:bg-dark-surface rounded-2xl shadow-2xl w-full max-w-md border border-gray-200 dark:border-dark-border overflow-hidden">
            <!-- Gradient Header -->
            <div class="gradient-amber px-6 py-4">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl bg-white/20 backdrop-blur flex items-center justify-center">
                        <i data-lucide="receipt" class="w-5 h-5 text-white"></i>
                    </div>
                    <h2 id="modalTitle" class="text-xl font-semibold text-white">
                        Add Transaction
                    </h2>
                </div>
            </div>

            <div class="p-6">
                <form id="transactionForm" action="/transactions" method="POST" class="space-y-5">
                    <input type="hidden" id="transactionId" name="id" value="">

                    <!-- Account -->
                    <div>
                        <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-2">
                            Account
                        </label>
                        <select name="account_id" id="transactionAccount" required class="select">
                            <option value="">Select an account</option>
                            {{range .Accounts}}
                            <option value="{{.ID}}">{{.Name}} ({{.Currency}})</option>
                            {{end}}
                        </select>
                    </div>

                    <!-- Amount -->
                    <div>
                        <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-2">
                            Amount
                        </label>
                        <div class="relative">
                            <input type="text" id="transactionAmountDisplay" data-format-number data-decimals="2" inputmode="decimal" required
                                class="w-full px-4 py-3 rounded-xl bg-gray-50 dark:bg-dark-bg border border-gray-200 dark:border-dark-border text-gray-900 dark:text-white placeholder-gray-400 focus:ring-2 focus:ring-amber-500/50 focus:border-amber-500 transition-all text-lg font-semibold"
                                placeholder="0,00">
                            <input type="hidden" name="amount" id="transactionAmount">
                        </div>
                        <p class="mt-1.5 text-xs text-gray-400">Use negative for withdrawals/expenses</p>
                    </div>

                    <!-- Date -->
                    <div>
                        <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-2">
                            Date
                        </label>
                        <input type="date" name="transaction_date" id="transactionDate" required
                            class="w-full px-4 py-3 rounded-xl bg-gray-50 dark:bg-dark-bg border border-gray-200 dark:border-dark-border text-gray-900 dark:text-white focus:ring-2 focus:ring-amber-500/50 focus:border-amber-500 transition-all">
                    </div>

                    <!-- Description -->
                    <div>
                        <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-2">
                            Description (optional)
                        </label>
                        <input type="text" name="description" id="transactionDescription"
                            class="w-full px-4 py-3 rounded-xl bg-gray-50 dark:bg-dark-bg border border-gray-200 dark:border-dark-border text-gray-900 dark:text-white placeholder-gray-400 focus:ring-2 focus:ring-amber-500/50 focus:border-amber-500 transition-all"
                            placeholder="e.g., Salary, Rent, Investment">
                    </div>

                    <!-- Quick Amount Buttons -->
                    <div>
                        <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-2">
                            Quick Amounts
                        </label>
                        <div class="flex flex-wrap gap-2">
                            <button type="button" onclick="setAmount(1000)" class="px-4 py-2 text-sm font-medium rounded-lg bg-emerald-500/10 text-emerald-500 border border-emerald-500/30 hover:bg-emerald-500/20 transition-all">+1,000</button>
                            <button type="button" onclick="setAmount(5000)" class="px-4 py-2 text-sm font-medium rounded-lg bg-emerald-500/10 text-emerald-500 border border-emerald-500/30 hover:bg-emerald-500/20 transition-all">+5,000</button>
                            <button type="button" onclick="setAmount(10000)" class="px-4 py-2 text-sm font-medium rounded-lg bg-emerald-500/10 text-emerald-500 border border-emerald-500/30 hover:bg-emerald-500/20 transition-all">+10,000</button>
                            <button type="button" onclick="setAmount(-500)" class="px-4 py-2 text-sm font-medium rounded-lg bg-red-500/10 text-red-500 border border-red-500/30 hover:bg-red-500/20 transition-all">-500</button>
                            <button type="button" onclick="setAmount(-1000)" class="px-4 py-2 text-sm font-medium rounded-lg bg-red-500/10 text-red-500 border border-red-500/30 hover:bg-red-500/20 transition-all">-1,000</button>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="flex gap-3 pt-4">
                        <button type="button" onclick="closeModal()" class="flex-1 px-4 py-2.5 text-xs font-medium rounded-lg border-2 border-gray-200 dark:border-dark-border text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-dark-hover transition-all">
                            Cancel
                        </button>
                        <button type="submit" class="flex-1 px-4 py-2.5 text-xs font-medium rounded-lg gradient-amber text-white shadow-lg shadow-amber-500/25 hover:shadow-amber-500/40 transition-all">
                            Save Transaction
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
function openCreateModal() {
    document.getElementById('modalTitle').textContent = 'Add Transaction';
    document.getElementById('transactionForm').action = '/transactions';
    document.getElementById('transactionForm').reset();
    document.getElementById('transactionAmountDisplay').value = '';
    document.getElementById('transactionAmount').value = '';
    document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
    document.getElementById('transactionModal').classList.remove('hidden');
}

function closeModal() {
    document.getElementById('transactionModal').classList.add('hidden');
}

function editTransaction(id, accountId, amount, description, date) {
    document.getElementById('modalTitle').textContent = 'Edit Transaction';
    document.getElementById('transactionForm').action = '/transactions/' + id;
    document.getElementById('transactionId').value = id;
    document.getElementById('transactionAccount').value = accountId;
    // Set hidden value for form submission
    document.getElementById('transactionAmount').value = amount;
    // Set formatted display value
    const displayInput = document.getElementById('transactionAmountDisplay');
    displayInput.value = NumberFormat.format(amount, 2);
    NumberFormat.initInput(displayInput);
    document.getElementById('transactionDescription').value = description || '';
    document.getElementById('transactionDate').value = date;
    document.getElementById('transactionModal').classList.remove('hidden');
}

function setAmount(amount) {
    const displayInput = document.getElementById('transactionAmountDisplay');
    const hiddenInput = document.getElementById('transactionAmount');
    hiddenInput.value = amount;
    displayInput.value = NumberFormat.format(amount, 2);
}

// Close modal on escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeModal();
    }
});
</script>
{{end}}
