{{define "content"}}
<div class="space-y-6">
    <!-- Page Header -->
    <div class="flex items-center justify-between">
        <div class="flex items-center gap-4">
            <a href="/settings/connections" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-dark-hover transition-all">
                <i data-lucide="arrow-left" class="w-5 h-5 text-gray-500 dark:text-gray-400"></i>
            </a>
            <div>
                <h1 class="text-2xl font-semibold text-gray-900 dark:text-white capitalize">
                    {{.Connection.BrokerType}} Connection
                </h1>
                {{if eq .Connection.BrokerType "saxo"}}
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">OAuth Browser Login ({{.Connection.Country | upper}})</p>
                {{else}}
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">{{.Connection.Username}} ({{.Connection.Country | upper}})</p>
                {{end}}
            </div>
        </div>
        <div class="flex items-center gap-3" x-data="brokerSync({{.Connection.ID}}, '{{.Connection.BrokerType}}')">
            <!-- MitID QR Code Overlay -->
            <div x-show="syncing || errorMsg || successMsg" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                <div class="bg-white dark:bg-dark-surface rounded-2xl p-8 max-w-md mx-4 text-center shadow-2xl">
                    <!-- Success State -->
                    <template x-if="successMsg">
                        <div>
                            <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-emerald-500/10 flex items-center justify-center">
                                <i data-lucide="check-circle" class="w-8 h-8 text-emerald-500"></i>
                            </div>
                            <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-2">Authentication Successful!</h3>
                            <p class="text-gray-600 dark:text-gray-400 mb-4 text-sm">Your <span class="capitalize" x-text="brokerType"></span> account has been connected successfully.</p>
                            <div class="flex items-center justify-center gap-2 text-sm text-emerald-500">
                                <i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i>
                                <span>Refreshing page...</span>
                            </div>
                        </div>
                    </template>
                    <!-- Error State -->
                    <template x-if="errorMsg && !successMsg">
                        <div>
                            <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-red-500/10 flex items-center justify-center">
                                <i data-lucide="alert-circle" class="w-8 h-8 text-red-500"></i>
                            </div>
                            <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-2">Authentication Failed</h3>
                            <p class="text-gray-600 dark:text-gray-400 mb-4 text-sm" x-text="errorMsg"></p>
                            <!-- Specific error help -->
                            <template x-if="errorType === 'ip_blocked'">
                                <div class="bg-amber-500/10 border border-amber-500/20 rounded-lg p-3 mb-4 text-left">
                                    <p class="text-xs text-amber-600 dark:text-amber-400">
                                        <strong>IP Blocked:</strong> MitID has temporarily blocked your IP address due to too many requests. Please wait 15-30 minutes and try again.
                                    </p>
                                </div>
                            </template>
                            <template x-if="errorType === 'parallel_sessions'">
                                <div class="bg-amber-500/10 border border-amber-500/20 rounded-lg p-3 mb-4 text-left">
                                    <p class="text-xs text-amber-600 dark:text-amber-400">
                                        <strong>Session Conflict:</strong> Multiple login attempts were detected. Please wait a moment and try again.
                                    </p>
                                </div>
                            </template>
                            <template x-if="errorType === 'timeout'">
                                <div class="bg-amber-500/10 border border-amber-500/20 rounded-lg p-3 mb-4 text-left">
                                    <p class="text-xs text-amber-600 dark:text-amber-400">
                                        <strong>Timeout:</strong> The authentication request timed out. Make sure to scan the QR code and approve in your MitID app within 2 minutes.
                                    </p>
                                </div>
                            </template>
                            <button @click="closeError()" class="px-4 py-2 text-sm font-medium rounded-lg bg-gray-100 dark:bg-dark-hover text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-dark-border transition-all">
                                Close
                            </button>
                        </div>
                    </template>
                    <!-- QR Code Display -->
                    <template x-if="qrReady && !syncingAccounts && !errorMsg && !successMsg">
                        <div>
                            <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-4">Scan with MitID App</h3>
                            <div class="bg-white p-4 rounded-lg inline-block mb-4">
                                <img :src="qrUrl + '?t=' + Date.now()"
                                     alt="MitID QR Code"
                                     class="w-48 h-48"
                                     x-effect="if(qrReady) { setInterval(() => $el.src = qrUrl + '?t=' + Date.now(), 1000) }">
                            </div>
                            <p class="text-gray-600 dark:text-gray-400 text-sm mb-2">
                                Open your <strong>MitID app</strong> and scan this QR code
                            </p>
                            <div class="flex items-center justify-center gap-2 text-sm text-gray-500 dark:text-gray-400">
                                <i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i>
                                <span>Waiting for approval...</span>
                            </div>
                            <p class="text-xs text-gray-400 dark:text-gray-500 mt-4">
                                This may take up to 2 minutes. The page will refresh automatically when done.
                            </p>
                            <button @click="cancelSync()" class="mt-4 px-4 py-2 text-sm text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                                Cancel
                            </button>
                        </div>
                    </template>
                    <!-- Syncing Accounts State (after QR auth, pulling data) -->
                    <template x-if="syncingAccounts && !errorMsg && !successMsg">
                        <div>
                            <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-emerald-500/10 flex items-center justify-center">
                                <i data-lucide="download-cloud" class="w-8 h-8 text-emerald-500 animate-pulse"></i>
                            </div>
                            <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-2">Syncing Your Accounts</h3>
                            <p class="text-gray-600 dark:text-gray-400 mb-4">
                                Authentication successful! Now fetching your portfolio data...
                            </p>
                            <div class="flex items-center justify-center gap-2 text-sm text-emerald-500">
                                <i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i>
                                <span x-text="status"></span>
                            </div>
                            <p class="text-xs text-gray-400 dark:text-gray-500 mt-4">
                                This usually takes a few seconds per account.
                            </p>
                        </div>
                    </template>
                    <!-- Loading State (before QR is ready) -->
                    <template x-if="!qrReady && !syncingAccounts && !errorMsg && !successMsg">
                        <div>
                            <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-blue-500/10 flex items-center justify-center">
                                <i data-lucide="loader-2" class="w-8 h-8 text-blue-500 animate-spin"></i>
                            </div>
                            <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-2">{{if eq .Connection.BrokerType "saxo"}}Connecting to Saxo...{{else}}Connecting to MitID...{{end}}</h3>
                            <p class="text-gray-600 dark:text-gray-400 mb-4">
                                Please wait while we establish a secure connection.
                            </p>
                            <p class="text-sm text-gray-500 dark:text-gray-400" x-text="status"></p>
                            <!-- Saxo OAuth URL Display (for Docker/headless environments) -->
                            <template x-if="authUrl && brokerType === 'saxo'">
                                <div class="mt-4 p-3 rounded-lg bg-emerald-500/10 border border-emerald-500/20">
                                    <p class="text-xs text-emerald-400 mb-2">Click below to open Saxo login:</p>
                                    <a :href="authUrl" target="_blank" rel="noopener noreferrer"
                                       class="inline-flex items-center gap-1.5 px-3 py-2 rounded-lg bg-emerald-500 text-white text-sm font-medium hover:bg-emerald-600 transition-all">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" x2="21" y1="14" y2="3"/></svg>
                                        Open Saxo Login
                                    </a>
                                </div>
                            </template>
                            <p class="text-xs text-gray-400 dark:text-gray-500 mt-4">
                                This may take up to 2 minutes. The page will refresh automatically when done.
                            </p>
                            <button @click="cancelSync()" class="mt-4 px-4 py-2 text-sm text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                                Cancel
                            </button>
                        </div>
                    </template>
                </div>
            </div>
            <button @click="startSync()"
                    :disabled="syncing"
                    class="px-4 py-2.5 text-sm font-medium rounded-xl bg-gray-100 dark:bg-dark-hover text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-dark-border transition-all flex items-center gap-2 disabled:opacity-50">
                <i data-lucide="refresh-cw" class="w-4 h-4" :class="syncing && 'animate-spin'"></i>
                <span x-show="!syncing">Sync Now</span>
                <span x-show="syncing" class="text-xs">Syncing...</span>
            </button>
            <a href="/settings/connections/{{.Connection.ID}}/edit"
               class="px-4 py-2.5 text-sm font-medium rounded-xl bg-indigo-500/10 text-indigo-500 hover:bg-indigo-500/20 transition-all flex items-center gap-2">
                <i data-lucide="pencil" class="w-4 h-4"></i>
                Edit
            </a>
            <form action="/settings/connections/{{.Connection.ID}}/delete" method="POST" class="inline"
                  onsubmit="return confirm('Are you sure you want to delete this connection?')">
                <button type="submit"
                        class="px-4 py-2.5 text-sm font-medium rounded-xl bg-red-500/10 text-red-500 hover:bg-red-500/20 transition-all flex items-center gap-2">
                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                    Delete
                </button>
            </form>
        </div>
    </div>

    {{if .Error}}
    <div class="bg-red-500/10 border border-red-500/20 rounded-lg p-4">
        <div class="flex items-center gap-2">
            <i data-lucide="alert-circle" class="w-5 h-5 text-red-500"></i>
            <p class="text-sm text-red-400">{{.Error}}</p>
        </div>
    </div>
    {{end}}

    <!-- Auth Info Banner - MitID for Nordnet, OAuth for Saxo -->
    {{if eq .Connection.BrokerType "saxo"}}
    <div class="bg-emerald-500/10 border border-emerald-500/20 rounded-lg p-4">
        <div class="flex items-start gap-3">
            <i data-lucide="globe" class="w-5 h-5 text-emerald-500 mt-0.5"></i>
            <div>
                <p class="text-sm text-emerald-400 font-medium">Browser Authentication</p>
                <p class="text-xs text-emerald-400/80 mt-1">When you click "Sync Now" or "Map Accounts", a browser window will open for you to log in at Saxo's website. Your session will be cached for convenience.</p>
            </div>
        </div>
    </div>
    {{else}}
    <div class="bg-blue-500/10 border border-blue-500/20 rounded-lg p-4">
        <div class="flex items-start gap-3">
            <i data-lucide="smartphone" class="w-5 h-5 text-blue-500 mt-0.5"></i>
            <div>
                <p class="text-sm text-blue-400 font-medium">MitID Authentication Required</p>
                <p class="text-xs text-blue-400/80 mt-1">When you click "Sync Now" or "Map Accounts", you'll need to approve the login in your MitID app. Keep your phone ready!</p>
            </div>
        </div>
    </div>
    {{end}}

    <!-- Connection Status -->
    <div class="rounded-2xl bg-white dark:bg-dark-surface border border-gray-200 dark:border-dark-border overflow-hidden">
        <div class="flex items-center gap-3 px-6 py-5 border-b border-gray-200 dark:border-dark-border">
            <div class="w-10 h-10 rounded-xl gradient-indigo flex items-center justify-center">
                <i data-lucide="activity" class="w-5 h-5 text-white"></i>
            </div>
            <div>
                <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Status</h2>
                <p class="text-xs text-gray-500 dark:text-gray-400">Connection health and sync status</p>
            </div>
        </div>

        <div class="p-6">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="p-4 rounded-xl bg-gray-50 dark:bg-dark-bg">
                    <p class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-1">Status</p>
                    {{if .Connection.IsActive}}
                    <p class="text-sm font-medium text-emerald-500">Active</p>
                    {{else}}
                    <p class="text-sm font-medium text-red-500">Inactive</p>
                    {{end}}
                </div>
                <div class="p-4 rounded-xl bg-gray-50 dark:bg-dark-bg">
                    <p class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-1">Last Sync</p>
                    {{if .Connection.LastSyncAt}}
                    <p class="text-sm font-medium text-gray-900 dark:text-white">{{.Connection.LastSyncAt.Format "Jan 02, 15:04"}}</p>
                    {{else}}
                    <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Never</p>
                    {{end}}
                </div>
                <div class="p-4 rounded-xl bg-gray-50 dark:bg-dark-bg">
                    <p class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-1">Sync Status</p>
                    {{if eq .Connection.LastSyncStatus "success"}}
                    <p class="text-sm font-medium text-emerald-500">Success</p>
                    {{else if eq .Connection.LastSyncStatus "error"}}
                    <p class="text-sm font-medium text-red-500">Error</p>
                    {{else if eq .Connection.LastSyncStatus "auth_failed"}}
                    <p class="text-sm font-medium text-amber-500">Auth Failed</p>
                    {{else}}
                    <p class="text-sm font-medium text-gray-500 dark:text-gray-400">-</p>
                    {{end}}
                </div>
                <div class="p-4 rounded-xl bg-gray-50 dark:bg-dark-bg">
                    <p class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-1">Mapped Accounts</p>
                    <p class="text-sm font-medium text-gray-900 dark:text-white">{{len .Mappings}}</p>
                </div>
            </div>

            {{if .Connection.LastSyncError}}
            <div class="mt-4 p-4 rounded-xl bg-red-500/10 border border-red-500/20">
                <p class="text-xs text-red-400">{{.Connection.LastSyncError}}</p>
            </div>
            {{end}}
        </div>
    </div>

    <!-- Account Mappings -->
    <div class="rounded-2xl bg-white dark:bg-dark-surface border border-gray-200 dark:border-dark-border overflow-hidden">
        <div class="flex items-center justify-between px-6 py-5 border-b border-gray-200 dark:border-dark-border">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl gradient-emerald flex items-center justify-center">
                    <i data-lucide="link" class="w-5 h-5 text-white"></i>
                </div>
                <div>
                    <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Account Mappings</h2>
                    <p class="text-xs text-gray-500 dark:text-gray-400">Link broker accounts to your local accounts</p>
                </div>
            </div>
            <a href="/settings/connections/{{.Connection.ID}}/accounts"
               class="px-4 py-2 text-sm font-medium rounded-lg bg-indigo-500 text-white hover:bg-indigo-600 transition-all">
                Edit Mappings
            </a>
        </div>

        <div class="p-6">
            {{if .Mappings}}
            <div class="space-y-3">
                {{range .Mappings}}
                <div class="flex items-center justify-between p-4 rounded-xl bg-gray-50 dark:bg-dark-bg">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg bg-blue-500/10 flex items-center justify-center">
                            <i data-lucide="wallet" class="w-4 h-4 text-blue-500"></i>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-900 dark:text-white">{{.ExternalAccountName}}</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400">ID: {{.ExternalAccountID}}</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <i data-lucide="arrow-right" class="w-4 h-4 text-gray-400"></i>
                        <span class="px-3 py-1 rounded-lg bg-indigo-500/10 text-xs text-indigo-500">Local Account #{{.LocalAccountID}}</span>
                        {{if .AutoSync}}
                        <span class="px-2 py-1 rounded bg-emerald-500/10 text-xs text-emerald-500">Auto-sync</span>
                        {{end}}
                    </div>
                </div>
                {{end}}
            </div>
            {{else}}
            <div class="text-center py-8">
                <p class="text-sm text-gray-500 dark:text-gray-400">No accounts mapped yet</p>
                <a href="/settings/connections/{{.Connection.ID}}/accounts"
                   class="inline-flex items-center gap-2 mt-4 px-4 py-2 text-sm font-medium rounded-lg bg-indigo-500/10 text-indigo-500 hover:bg-indigo-500/20 transition-all">
                    <i data-lucide="plus" class="w-4 h-4"></i>
                    Map Accounts
                </a>
            </div>
            {{end}}
        </div>
    </div>

    <!-- Sync History -->
    {{if .History}}
    <div class="rounded-2xl bg-white dark:bg-dark-surface border border-gray-200 dark:border-dark-border overflow-hidden">
        <div class="flex items-center gap-3 px-6 py-5 border-b border-gray-200 dark:border-dark-border">
            <div class="w-10 h-10 rounded-xl gradient-violet flex items-center justify-center">
                <i data-lucide="history" class="w-5 h-5 text-white"></i>
            </div>
            <div>
                <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Sync History</h2>
                <p class="text-xs text-gray-500 dark:text-gray-400">Recent synchronization attempts</p>
            </div>
        </div>

        <div class="overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr class="border-b border-gray-200 dark:border-dark-border">
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Time</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Type</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Accounts</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Positions</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Duration</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200 dark:divide-dark-border">
                    {{range .History}}
                    <tr class="hover:bg-gray-50 dark:hover:bg-dark-hover">
                        <td class="px-6 py-4 text-sm text-gray-900 dark:text-white">{{.StartedAt.Format "Jan 02, 15:04"}}</td>
                        <td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-400 capitalize">{{.SyncType}}</td>
                        <td class="px-6 py-4">
                            {{if eq .Status "success"}}
                            <span class="px-2 py-1 rounded bg-emerald-500/10 text-xs text-emerald-500">Success</span>
                            {{else if eq .Status "error"}}
                            <span class="px-2 py-1 rounded bg-red-500/10 text-xs text-red-500">Error</span>
                            {{else}}
                            <span class="px-2 py-1 rounded bg-gray-500/10 text-xs text-gray-500">{{.Status}}</span>
                            {{end}}
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-400">{{.AccountsSynced}}</td>
                        <td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-400">{{.PositionsSynced}}</td>
                        <td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-400">{{.DurationMs}}ms</td>
                    </tr>
                    {{end}}
                </tbody>
            </table>
        </div>
    </div>
    {{end}}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
});

// Broker Sync Alpine.js component - handles both MitID (Nordnet) and OAuth (Saxo)
function brokerSync(connectionId, brokerType) {
    return {
        syncing: false,
        qrReady: false,
        syncingAccounts: false,
        status: 'Initializing...',
        errorMsg: null,
        errorType: null,
        successMsg: null,
        brokerType: brokerType,
        authUrl: null,

        init() {
            // Auto-start sync if ?action=sync is in URL
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('action') === 'sync') {
                // Remove the action param from URL without reload
                const newUrl = window.location.pathname;
                window.history.replaceState({}, '', newUrl);
                // Start sync after a short delay to let Alpine initialize
                setTimeout(() => this.startSync(), 100);
            }
        },
        qrUrl: `/settings/connections/${connectionId}/mitid/qr`,
        statusUrl: brokerType === 'saxo'
            ? `/settings/connections/${connectionId}/saxo/status`
            : `/settings/connections/${connectionId}/mitid/status`,
        syncUrl: `/settings/connections/${connectionId}/sync`,
        pollInterval: null,
        qrRefreshInterval: null,
        syncRequest: null,

        async startSync() {
            this.syncing = true;
            this.qrReady = false;
            this.syncingAccounts = false;
            this.errorMsg = null;
            this.errorType = null;
            this.successMsg = null;
            this.status = this.brokerType === 'saxo'
                ? 'Starting OAuth authentication...'
                : 'Starting MitID authentication...';

            // Re-initialize icons after state change
            setTimeout(() => lucide.createIcons(), 50);

            // Start the sync request in background
            this.syncRequest = fetch(this.syncUrl, { method: 'POST' })
                .then(async response => {
                    this.stopPolling();
                    if (response.ok) {
                        // Show success message before reloading
                        this.syncing = false;
                        this.qrReady = false;
                        this.syncingAccounts = false;
                        this.successMsg = true;
                        setTimeout(() => lucide.createIcons(), 50);
                        // Reload after 2 seconds to let user see success
                        setTimeout(() => window.location.reload(), 2000);
                    } else {
                        const text = await response.text();
                        this.handleError(text);
                    }
                })
                .catch(err => {
                    this.stopPolling();
                    this.handleError(err.message);
                });

            // Start polling for QR code status
            this.startPolling();
        },

        handleError(errorText) {
            this.syncing = false;
            this.qrReady = false;
            this.syncingAccounts = false;
            this.errorMsg = this.parseErrorMessage(errorText);
            this.errorType = this.detectErrorType(errorText);

            // Re-initialize icons for error state
            setTimeout(() => lucide.createIcons(), 50);
        },

        parseErrorMessage(text) {
            // Clean up the error message for display
            let msg = text;

            // Extract meaningful part from nested error messages
            if (msg.includes('client_ip_blocked')) {
                return 'Your IP address has been temporarily blocked by MitID.';
            }
            if (msg.includes('parallel_sessions_detected') || msg.includes('to steder samtidigt')) {
                return 'Multiple login sessions detected. Please wait and try again.';
            }
            if (msg.includes('timed out') || msg.includes('timeout')) {
                return 'Authentication timed out. Please try again and approve quickly in your MitID app.';
            }
            if (msg.includes('authenticator_cannot_be_started')) {
                return 'Could not start MitID authentication. Please try again in a moment.';
            }
            if (msg.includes('identity_not_found')) {
                return 'MitID user not found. Please check your MitID username.';
            }

            // Remove technical prefixes
            msg = msg.replace(/^MitID authentication failed:\s*/gi, '');
            msg = msg.replace(/^exit status \d+:\s*/gi, '');

            // Truncate very long messages
            if (msg.length > 200) {
                msg = msg.substring(0, 200) + '...';
            }

            return msg || 'An unknown error occurred';
        },

        detectErrorType(text) {
            if (text.includes('client_ip_blocked')) {
                return 'ip_blocked';
            }
            if (text.includes('parallel_sessions') || text.includes('to steder samtidigt')) {
                return 'parallel_sessions';
            }
            if (text.includes('timed out') || text.includes('timeout') || text.includes('DeadlineExceeded')) {
                return 'timeout';
            }
            return 'generic';
        },

        formatStatus(status) {
            if (this.brokerType === 'saxo') {
                // Saxo OAuth status messages
                const saxoStatusMessages = {
                    'pending': 'Preparing OAuth login...',
                    'waiting': 'Browser opened - please log in at Saxo',
                    'exchanging': 'Exchanging authorization token...',
                    'complete': 'Authentication complete!',
                    'failed': 'Authentication failed',
                    'none': 'Starting sync...'
                };
                return saxoStatusMessages[status] || status;
            } else {
                // MitID status messages
                const statusMessages = {
                    'initializing': 'Connecting to MitID...',
                    'qr_ready': 'Scan the QR code with your MitID app',
                    'waiting_for_approval': 'Waiting for approval in MitID app...',
                    'approved': 'Approved! Completing login...',
                    'complete': 'Authentication complete!',
                    'syncing': 'Syncing your accounts...',
                    'failed': 'Authentication failed',
                    'cached': 'Using saved session...',
                    'none': 'Starting sync...'
                };
                return statusMessages[status] || status;
            }
        },

        startPolling() {
            // Poll status every 500ms
            this.pollInterval = setInterval(async () => {
                try {
                    const response = await fetch(this.statusUrl);
                    if (response.ok) {
                        const data = await response.json();
                        this.status = this.formatStatus(data.status);

                        // Capture auth URL for Saxo OAuth (to display clickable link)
                        if (data.auth_url) {
                            this.authUrl = data.auth_url;
                        }

                        if (data.status === 'qr_ready') {
                            this.qrReady = true;
                            this.syncingAccounts = false;
                        } else if (data.status === 'complete' || data.status === 'approved') {
                            // Auth complete, now syncing accounts
                            this.qrReady = false;
                            this.syncingAccounts = true;
                            this.status = 'Pulling account data...';
                            setTimeout(() => lucide.createIcons(), 50);
                        } else if (data.status === 'failed') {
                            this.stopPolling();
                            this.status = 'Authentication failed';
                        }
                    } else if (response.status === 404) {
                        // No active auth session - using cached session or sync in progress
                        if (this.qrReady) {
                            // QR was shown before, now auth complete
                            this.qrReady = false;
                            this.syncingAccounts = true;
                            this.status = 'Pulling account data...';
                            setTimeout(() => lucide.createIcons(), 50);
                        } else if (!this.syncingAccounts) {
                            // Using cached session
                            this.syncingAccounts = true;
                            this.status = 'Using saved session...';
                            setTimeout(() => lucide.createIcons(), 50);
                        }
                    }
                } catch (e) {
                    // Ignore polling errors
                }
            }, 500);
        },

        stopPolling() {
            if (this.pollInterval) {
                clearInterval(this.pollInterval);
                this.pollInterval = null;
            }
            if (this.qrRefreshInterval) {
                clearInterval(this.qrRefreshInterval);
                this.qrRefreshInterval = null;
            }
        },

        cancelSync() {
            this.stopPolling();
            this.syncing = false;
            this.qrReady = false;
            this.syncingAccounts = false;
            this.errorMsg = null;
            this.errorType = null;
            this.successMsg = null;
        },

        closeError() {
            this.errorMsg = null;
            this.errorType = null;
            this.syncing = false;
        }
    };
}
</script>
{{end}}
